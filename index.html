<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#3B82F6">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="タスク記録">
  <title>タスク時間記録</title>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    body { margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // ⚠️ ここにFirebaseの設定を貼り付けてください ⚠️
    const firebaseConfig = {
  apiKey: "AIzaSyBazLiYdO0nsVEou8-x1stiFDmDa3kGuYY",
  authDomain: "tasktimetraker.firebaseapp.com",
  projectId: "tasktimetraker",
  storageBucket: "tasktimetraker.firebasestorage.app",
  messagingSenderId: "654716377904",
  appId: "1:654716377904:web:10fc33b37191aad65386f5"
};

    // Firebase初期化
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();

    // デフォルトカラーパレット
    const colorPalette = [
      '#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6',
      '#EC4899', '#14B8A6', '#F97316', '#6366F1', '#84CC16',
      '#06B6D4', '#F43F5E', '#22C55E', '#A855F7', '#EAB308'
    ];

    const getDefaultTaskColor = (taskName) => {
      let hash = 0;
      for (let i = 0; i < taskName.length; i++) {
        hash = taskName.charCodeAt(i) + ((hash << 5) - hash);
      }
      return colorPalette[Math.abs(hash) % colorPalette.length];
    };

    // アイコン
    const PlusIcon = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
    );

    const ClockIcon = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="12 6 12 12 16 14"></polyline>
      </svg>
    );

    const CalendarIcon = () => (
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="mx-auto mb-3 opacity-50">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
    );

    const BarChartIcon = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="12" y1="20" x2="12" y2="10"></line>
        <line x1="18" y1="20" x2="18" y2="4"></line>
        <line x1="6" y1="20" x2="6" y2="16"></line>
      </svg>
    );

    const TrendingUpIcon = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
        <polyline points="17 6 23 6 23 12"></polyline>
      </svg>
    );

    const SettingsIcon = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M12 1v6m0 6v6m-9-9h6m6 0h6m-16.97 6.03l4.24-4.24m6.36 0l4.24 4.24M6.03 4.97l4.24 4.24m6.36 0l4.24-4.24"></path>
      </svg>
    );

    const TrashIcon = () => (
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="3 6 5 6 21 6"></polyline>
        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
      </svg>
    );

    const ChevronDownIcon = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="6 9 12 15 18 9"></polyline>
      </svg>
    );

    const ChevronUpIcon = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="18 15 12 9 6 15"></polyline>
      </svg>
    );

    const ChevronLeftIcon = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
    );

    const ChevronRightIcon = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    );

    const ArrowLeftIcon = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="19" y1="12" x2="5" y2="12"></line>
        <polyline points="12 19 5 12 12 5"></polyline>
      </svg>
    );

    const UserIcon = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
        <circle cx="12" cy="7" r="4"></circle>
      </svg>
    );

    const LogOutIcon = () => (
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
        <polyline points="16 17 21 12 16 7"></polyline>
        <line x1="21" y1="12" x2="9" y2="12"></line>
      </svg>
    );

    const CloudIcon = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>
      </svg>
    );

    const XIcon = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    );

    function TaskTimeTracker() {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      const [tasks, setTasks] = useState([]);
      const [taskColors, setTaskColors] = useState({});
      const [taskName, setTaskName] = useState('');
      const [hours, setHours] = useState('');
      const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
      const [view, setView] = useState('day');
      const [syncing, setSyncing] = useState(false);
      const [showColorSettings, setShowColorSettings] = useState(false);
      const [showYearPicker, setShowYearPicker] = useState(false);
      const [expandedPeriods, setExpandedPeriods] = useState({});
      const [calendarDate, setCalendarDate] = useState(new Date());
      const [selectedDate, setSelectedDate] = useState(null);

      useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged((user) => {
          setUser(user);
          setLoading(false);
          if (user) {
            loadTasksFromFirestore(user.uid);
            loadTaskColors(user.uid);
          }
        });

        return () => unsubscribe();
      }, []);

      const signInWithGoogle = async () => {
        try {
          const provider = new firebase.auth.GoogleAuthProvider();
          await auth.signInWithPopup(provider);
        } catch (error) {
          console.error('ログインエラー:', error);
          alert('ログインに失敗しました: ' + error.message);
        }
      };

      const signOut = async () => {
        try {
          await auth.signOut();
          setTasks([]);
          setTaskColors({});
        } catch (error) {
          console.error('ログアウトエラー:', error);
        }
      };

      const loadTasksFromFirestore = async (userId) => {
        try {
          setSyncing(true);
          const snapshot = await db.collection('users').doc(userId).collection('tasks').get();
          const loadedTasks = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
          setTasks(loadedTasks);
        } catch (error) {
          console.error('データ読み込みエラー:', error);
        } finally {
          setSyncing(false);
        }
      };

      const loadTaskColors = async (userId) => {
        try {
          const doc = await db.collection('users').doc(userId).collection('settings').doc('taskColors').get();
          if (doc.exists) {
            setTaskColors(doc.data().colors || {});
          }
        } catch (error) {
          console.error('色設定読み込みエラー:', error);
        }
      };

      const saveTaskColors = async (colors) => {
        if (!user) return;
        try {
          await db.collection('users').doc(user.uid).collection('settings').doc('taskColors').set({
            colors: colors
          });
        } catch (error) {
          console.error('色設定保存エラー:', error);
        }
      };

      const getTaskColor = (taskName) => {
        return taskColors[taskName] || getDefaultTaskColor(taskName);
      };

      const updateTaskColor = (taskName, color) => {
        const newColors = { ...taskColors, [taskName]: color };
        setTaskColors(newColors);
        saveTaskColors(newColors);
      };

      const addTask = async () => {
        if (!taskName || !hours || !date || !user) return;
        
        const newTask = {
          name: taskName,
          hours: parseFloat(hours),
          date: date,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        try {
          setSyncing(true);
          const docRef = await db.collection('users').doc(user.uid).collection('tasks').add(newTask);
          setTasks([...tasks, { id: docRef.id, ...newTask }]);
          
          if (!taskColors[taskName]) {
            const newColors = { ...taskColors, [taskName]: getDefaultTaskColor(taskName) };
            setTaskColors(newColors);
            saveTaskColors(newColors);
          }
          
          setTaskName('');
          setHours('');
        } catch (error) {
          console.error('保存エラー:', error);
          alert('保存に失敗しました');
        } finally {
          setSyncing(false);
        }
      };

      const deleteTask = async (id) => {
        if (!user) return;
        
        try {
          setSyncing(true);
          await db.collection('users').doc(user.uid).collection('tasks').doc(id).delete();
          setTasks(tasks.filter(t => t.id !== id));
        } catch (error) {
          console.error('削除エラー:', error);
          alert('削除に失敗しました');
        } finally {
          setSyncing(false);
        }
      };

      const toggleExpand = (periodKey) => {
        setExpandedPeriods(prev => ({
          ...prev,
          [periodKey]: !prev[periodKey]
        }));
      };

      const getUniqueTaskNames = () => {
        return [...new Set(tasks.map(t => t.name))].sort();
      };

      const getWeekNumber = (date) => {
        const d = new Date(date);
        d.setHours(0, 0, 0, 0);
        d.setDate(d.getDate() + 4 - (d.getDay() || 7));
        const yearStart = new Date(d.getFullYear(), 0, 1);
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
      };

      const getWeekOfMonth = (dateStr) => {
        const date = new Date(dateStr);
        const firstDayOfMonth = new Date(date.getFullYear(), date.getMonth(), 1);
        const dayOfWeek = firstDayOfMonth.getDay();
        const offsetDate = date.getDate() + dayOfWeek;
        return Math.ceil(offsetDate / 7);
      };

      const getWeekDateRange = (year, week) => {
        const simple = new Date(year, 0, 1 + (week - 1) * 7);
        const dow = simple.getDay();
        const ISOweekStart = simple;
        if (dow <= 4)
          ISOweekStart.setDate(simple.getDate() - simple.getDay());
        else
          ISOweekStart.setDate(simple.getDate() + 7 - simple.getDay());
        
        const dates = [];
        for (let i = 0; i < 7; i++) {
          const d = new Date(ISOweekStart);
          d.setDate(ISOweekStart.getDate() + i);
          dates.push(d.toISOString().split('T')[0]);
        }
        return dates;
      };

      const formatWeekLabel = (year, week) => {
        const dates = getWeekDateRange(year, week);
        const startDate = new Date(dates[0]);
        const endDate = new Date(dates[6]);
        
        const startMonth = startDate.getMonth() + 1;
        const endMonth = endDate.getMonth() + 1;
        
        if (startMonth === endMonth) {
          const weekOfMonth = getWeekOfMonth(dates[0]);
          return `${startMonth}月 第${weekOfMonth}週`;
        } else {
          const startWeek = getWeekOfMonth(dates[0]);
          return `${startMonth}~${endMonth}月 第${startWeek}週`;
        }
      };

      const formatDate = (dateStr) => {
        const d = new Date(dateStr);
        const dayNames = ['日', '月', '火', '水', '木', '金', '土'];
        return `${d.getMonth() + 1}月${d.getDate()}日(${dayNames[d.getDay()]})`;
      };

      const formatShortDate = (dateStr) => {
        const d = new Date(dateStr);
        return `${d.getMonth() + 1}/${d.getDate()}`;
      };

      const getDaySummary = (limitDays = null) => {
        const summary = {};
        tasks.forEach(task => {
          const key = task.date;
          if (!summary[key]) summary[key] = {};
          if (!summary[key][task.name]) summary[key][task.name] = 0;
          summary[key][task.name] += task.hours;
        });
        
        if (limitDays) {
          const sortedDates = Object.keys(summary).sort().reverse().slice(0, limitDays);
          const limited = {};
          sortedDates.forEach(date => limited[date] = summary[date]);
          return limited;
        }
        
        return summary;
      };

      const getWeekSummary = (limitWeeks = null) => {
        const summary = {};
        tasks.forEach(task => {
          const taskDate = new Date(task.date);
          const year = taskDate.getFullYear();
          const week = getWeekNumber(task.date);
          const key = `${year}-W${week}`;
          
          if (!summary[key]) {
            summary[key] = {
              display: formatWeekLabel(year, week),
              tasks: {},
              year: year,
              week: week
            };
          }
          if (!summary[key].tasks[task.name]) summary[key].tasks[task.name] = 0;
          summary[key].tasks[task.name] += task.hours;
        });
        
        if (limitWeeks) {
          const sortedKeys = Object.keys(summary).sort().reverse().slice(0, limitWeeks);
          const limited = {};
          sortedKeys.forEach(key => limited[key] = summary[key]);
          return limited;
        }
        
        return summary;
      };

      const getMonthSummary = (limitMonths = null) => {
        const summary = {};
        tasks.forEach(task => {
          const taskDate = new Date(task.date);
          const year = taskDate.getFullYear();
          const month = taskDate.getMonth() + 1;
          const key = `${year}-M${month}`;
          
          if (!summary[key]) {
            summary[key] = {
              display: `${year}年${month}月`,
              tasks: {},
              year: year,
              month: month
            };
          }
          if (!summary[key].tasks[task.name]) summary[key].tasks[task.name] = 0;
          summary[key].tasks[task.name] += task.hours;
        });
        
        if (limitMonths) {
          const sortedKeys = Object.keys(summary).sort().reverse().slice(0, limitMonths);
          const limited = {};
          sortedKeys.forEach(key => limited[key] = summary[key]);
          return limited;
        }
        
        return summary;
      };

      const getYearSummary = () => {
        const summary = {};
        tasks.forEach(task => {
          const taskDate = new Date(task.date);
          const year = taskDate.getFullYear();
          const key = `${year}`;
          
          if (!summary[key]) {
            summary[key] = {
              display: `${year}年`,
              tasks: {},
              year: year
            };
          }
          if (!summary[key].tasks[task.name]) summary[key].tasks[task.name] = 0;
          summary[key].tasks[task.name] += task.hours;
        });
        
        return summary;
      };

      const getWeeksInMonth = (year, month) => {
        const weeks = {};
        tasks.forEach(task => {
          const taskDate = new Date(task.date);
          if (taskDate.getFullYear() === year && taskDate.getMonth() + 1 === month) {
            const week = getWeekNumber(task.date);
            const key = `${year}-W${week}`;
            
            if (!weeks[key]) {
              weeks[key] = {
                display: formatWeekLabel(year, week),
                tasks: {},
                year: year,
                week: week
              };
            }
            if (!weeks[key].tasks[task.name]) weeks[key].tasks[task.name] = 0;
            weeks[key].tasks[task.name] += task.hours;
          }
        });
        return weeks;
      };

      const getMonthsInYear = (year) => {
        const months = {};
        tasks.forEach(task => {
          const taskDate = new Date(task.date);
          if (taskDate.getFullYear() === year) {
            const month = taskDate.getMonth() + 1;
            const key = `${year}-M${month}`;
            
            if (!months[key]) {
              months[key] = {
                display: `${month}月`,
                tasks: {},
                year: year,
                month: month
              };
            }
            if (!months[key].tasks[task.name]) months[key].tasks[task.name] = 0;
            months[key].tasks[task.name] += task.hours;
          }
        });
        return months;
      };

      const getDaysInWeek = (year, week) => {
        const dates = getWeekDateRange(year, week);
        const days = {};
        
        dates.forEach(dateStr => {
          const tasksForDay = tasks.filter(t => t.date === dateStr);
          if (tasksForDay.length > 0) {
            days[dateStr] = {};
            tasksForDay.forEach(task => {
              if (!days[dateStr][task.name]) days[dateStr][task.name] = 0;
              days[dateStr][task.name] += task.hours;
            });
          }
        });
        
        return days;
      };

      const handleDateClick = (dateStr) => {
        setSelectedDate(dateStr);
        setView('day');
      };

      const handleWeekClick = (startDate) => {
        const date = new Date(startDate);
        const year = date.getFullYear();
        const week = getWeekNumber(startDate);
        setSelectedDate(`${year}-W${week}`);
        setView('week');
      };

      const handleMonthClick = () => {
        const year = calendarDate.getFullYear();
        const month = calendarDate.getMonth() + 1;
        setSelectedDate(`${year}-M${month}`);
        setView('month');
      };

      const renderCalendar = () => {
        const year = calendarDate.getFullYear();
        const month = calendarDate.getMonth();
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        const weeks = [];
        let days = [];
        
        for (let i = 0; i < firstDay; i++) {
          days.push(null);
        }
        
        for (let day = 1; day <= daysInMonth; day++) {
          days.push(day);
          
          if (days.length === 7) {
            weeks.push(days);
            days = [];
          }
        }
        
        if (days.length > 0) {
          while (days.length < 7) {
            days.push(null);
          }
          weeks.push(days);
        }

        return (
          <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div className="flex items-center justify-between mb-4">
              <button
                onClick={() => setCalendarDate(new Date(year, month - 1))}
                className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
              >
                <ChevronLeftIcon />
              </button>
              
              <div className="flex items-center gap-2">
                <button
                  onClick={() => setShowYearPicker(true)}
                  className="text-xl font-bold text-gray-800 hover:text-blue-600 transition-colors"
                >
                  {year}年
                </button>
                <button
                  onClick={handleMonthClick}
                  className="text-xl font-bold text-gray-800 hover:text-blue-600 transition-colors"
                >
                  {month + 1}月
                </button>
              </div>
              
              <button
                onClick={() => setCalendarDate(new Date(year, month + 1))}
                className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
              >
                <ChevronRightIcon />
              </button>
            </div>

            <div className="grid grid-cols-8 gap-1">
              <div></div>
              {['日', '月', '火', '水', '木', '金', '土'].map(day => (
                <div key={day} className="text-center text-sm font-medium text-gray-600 py-2">
                  {day}
                </div>
              ))}
              
              {weeks.map((week, weekIdx) => {
                const weekStartDate = week.find(d => d !== null);
                const weekStartDateStr = weekStartDate ? 
                  `${year}-${String(month + 1).padStart(2, '0')}-${String(weekStartDate).padStart(2, '0')}` : null;
                
                return (
                  <React.Fragment key={weekIdx}>
                    <div className="flex items-center justify-center">
                      {weekStartDateStr && (
                        <button
                          onClick={() => handleWeekClick(weekStartDateStr)}
                          className="w-6 h-6 flex items-center justify-center text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded transition-colors text-xs"
                          title="この週を表示"
                        >
                          ›
                        </button>
                      )}
                    </div>
                    
                    {week.map((day, dayIdx) => (
                      <div key={dayIdx} className="aspect-square">
                        {day && (
                          <button
                            onClick={() => handleDateClick(`${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`)}
                            className="w-full h-full flex items-center justify-center hover:bg-blue-50 rounded-lg transition-colors text-sm"
                          >
                            {day}
                          </button>
                        )}
                      </div>
                    ))}
                  </React.Fragment>
                );
              })}
            </div>
          </div>
        );
      };

      const renderYearPicker = () => {
        const currentYear = new Date().getFullYear();
        const years = [];
        for (let i = currentYear - 10; i <= currentYear + 10; i++) {
          years.push(i);
        }

        return (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-xl shadow-2xl max-w-md w-full max-h-[80vh] overflow-y-auto">
              <div className="sticky top-0 bg-white border-b p-4 flex items-center justify-between">
                <h2 className="text-xl font-bold text-gray-800">年を選択</h2>
                <button 
                  onClick={() => setShowYearPicker(false)}
                  className="text-gray-500 hover:text-gray-700"
                >
                  <XIcon />
                </button>
              </div>
              
              <div className="p-4 grid grid-cols-3 gap-3">
                {years.map(year => (
                  <button
                    key={year}
                    onClick={() => {
                      setCalendarDate(new Date(year, calendarDate.getMonth()));
                      setShowYearPicker(false);
                    }}
                    className={`py-3 rounded-lg font-medium transition-colors ${
                      year === calendarDate.getFullYear()
                        ? 'bg-blue-600 text-white'
                        : 'bg-gray-100 hover:bg-gray-200 text-gray-800'
                    }`}
                  >
                    {year}
                  </button>
                ))}
              </div>
            </div>
          </div>
        );
      };

      const renderColorSettings = () => {
        const uniqueTasks = getUniqueTaskNames();
        
        